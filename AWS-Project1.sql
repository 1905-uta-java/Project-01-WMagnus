SET AUTOCOMMIT ON

--TABLE CREATIONS
CREATE TABLE EMPLOYEES
(
    EMPLOYEE_ID         NUMBER                              NOT NULL,
    FIRST_NAME          VARCHAR2(32)                        NOT NULL,
    LAST_NAME           VARCHAR2(32)                        NOT NULL,
    EMAIL               VARCHAR2(32)                        NOT NULL,
    USERNAME            VARCHAR2(32)                        NOT NULL UNIQUE,
    HASHPASS            VARCHAR2(64)                        NOT NULL,
    NEEDS_RESET         CHAR(1)                         NOT NULL,
    CONSTRAINT          PK_EMPLOYEES                        PRIMARY KEY (EMPLOYEE_ID)
);

CREATE TABLE MANAGEMENT_HIERARCHY
(
    MH_ID               NUMBER                              NOT NULL,
    SUBORDINATE         NUMBER                              NOT NULL,
    SUPERIOR            NUMBER                              NOT NULL,
    CONSTRAINT          PK_MGMT_HIERARCHY                   PRIMARY KEY(MH_ID)
);

CREATE TABLE REQUESTS
(
    REQ_ID              NUMBER                              NOT NULL,
    POST_EMPLOYEE       NUMBER                              NOT NULL,
    RESOLVING_MGR       NUMBER,
    APPROVAL_STATE      CHAR(1)                         NOT NULL,
    SUBJECT             VARCHAR2(64)                        NOT NULL,
    EXPLANATION         VARCHAR2(1024),
    AMOUNT              NUMBER                              NOT NULL,
    CONSTRAINT          PK_REQUESTS                         PRIMARY KEY(REQ_ID)
);

--NON FK CONSTRAINTS
ALTER TABLE MANAGEMENT_HIERARCHY
    ADD CHECK (SUBORDINATE != SUPERIOR);

ALTER TABLE REQUESTS
    ADD CHECK (POST_EMPLOYEE != RESOLVING_MGR);
    
ALTER TABLE REQUESTS
    ADD CHECK (AMOUNT > 0);
    
--FK CONSTRAINTS
ALTER TABLE MANAGEMENT_HIERARCHY
    ADD CONSTRAINT FK_MGMT_HIER_SUPERIOR
    FOREIGN KEY (SUPERIOR) REFERENCES EMPLOYEES(EMPLOYEE_ID);
ALTER TABLE MANAGEMENT_HIERARCHY
    ADD CONSTRAINT FK_MGMT_HIER_SUBORD
    FOREIGN KEY (SUBORDINATE) REFERENCES EMPLOYEES(EMPLOYEE_ID);
ALTER TABLE REQUESTS
    ADD CONSTRAINT FK_REQ_POST_EMPLOYEE
    FOREIGN KEY (POST_EMPLOYEE) REFERENCES EMPLOYEES(EMPLOYEE_ID);
ALTER TABLE REQUESTS
    ADD CONSTRAINT FK_REQ_RESOLV_MGR
    FOREIGN KEY (RESOLVING_MGR) REFERENCES EMPLOYEES(EMPLOYEE_ID);
    
--AUTO ITERATING ID RULES
CREATE SEQUENCE EMPLOYEE_SEQ;
CREATE SEQUENCE MGMT_HIER_SEQ;
CREATE SEQUENCE REQUEST_SEQ;

CREATE OR REPLACE TRIGGER EMPLOYEE_ON_INSERT
BEFORE INSERT ON EMPLOYEES
FOR EACH ROW
BEGIN
    SELECT EMPLOYEE_SEQ.NEXTVAL
    INTO :NEW.EMPLOYEE_ID
    FROM DUAL;
END;
/

CREATE OR REPLACE TRIGGER MGMT_HIER_ON_INSERT
BEFORE INSERT ON MANAGEMENT_HIERARCHY
FOR EACH ROW
BEGIN
    SELECT MGMT_HIER_SEQ.NEXTVAL
    INTO :NEW.MH_ID
    FROM DUAL;
END;
/

CREATE OR REPLACE TRIGGER REQUEST_ON_INSERT
BEFORE INSERT ON REQUESTS
FOR EACH ROW
BEGIN
    SELECT REQUEST_SEQ.NEXTVAL
    INTO :NEW.REQ_ID
    FROM DUAL;
END;
/

--ADDING DATA
--EMPLOYEES (FOR NEEDS RESET, N IS NO, Y IS YES (THE JOYS OF VARCHAR2)
INSERT INTO EMPLOYEES (EMPLOYEE_ID, FIRST_NAME, LAST_NAME, EMAIL, USERNAME, HASHPASS, NEEDS_RESET) VALUES (1, 'Mann', 'Unterling', 'wolfemagnus@nevada.unr.edu', 'munterling', UPPER('198dcbb8890e757a8de1dbd03d9c587d8fc412b553b04c25cb96e7605fdbe33c'), 'n'); --password_01
INSERT INTO EMPLOYEES (EMPLOYEE_ID, FIRST_NAME, LAST_NAME, EMAIL, USERNAME, HASHPASS, NEEDS_RESET) VALUES (2, 'Sarah', 'Unterling', 'wolfemagnus@nevada.unr.edu', 'sunterling', UPPER('2d1ce5957facc316107a9ac0fe140685d00cb4acbd9cc7d40c4fc01299f83892'), 'n'); --password_02
INSERT INTO EMPLOYEES (EMPLOYEE_ID, FIRST_NAME, LAST_NAME, EMAIL, USERNAME, HASHPASS, NEEDS_RESET) VALUES (3, 'James', 'Subortinatus', 'wolfemagnus@nevada.unr.edu', 'jsubordinatus', UPPER('d358f43a2f8dda8b142ef0466701d675835dff30b8d2afd1264e1d3515df7afc'), 'n'); --password_03
INSERT INTO EMPLOYEES (EMPLOYEE_ID, FIRST_NAME, LAST_NAME, EMAIL, USERNAME, HASHPASS, NEEDS_RESET) VALUES (4, 'Jack', 'Laissie', 'wolfemagnus@nevada.unr.edu', 'jlaissie', UPPER('5cc5e3ae2bc58bfe20a50906a8b560221a9a76ac1cefa009ad43c9d3bf7d037a'), 'n'); --password_04
INSERT INTO EMPLOYEES (EMPLOYEE_ID, FIRST_NAME, LAST_NAME, EMAIL, USERNAME, HASHPASS, NEEDS_RESET) VALUES (5, 'Arnold', 'Overwerk', 'wolfemagnus@nevada.unr.edu', 'aoverwerk', UPPER('c91cb0520009f5c65665fc271ab1cd762714fd9f56012f746cc3e79d8b5f6875'), 'n'); --password_05
--MIDLEVEL MANAGERS
INSERT INTO EMPLOYEES (EMPLOYEE_ID, FIRST_NAME, LAST_NAME, EMAIL, USERNAME, HASHPASS, NEEDS_RESET) VALUES (6, 'Samuel', 'Middlemann', 'wolfemagnus@nevada.unr.edu', 'smiddleman', UPPER('49986d126a73d926f9711259885e3b74c0f6458b633e32d2f96a29dd3561d99d'), 'n'); --password_06
INSERT INTO EMPLOYEES (EMPLOYEE_ID, FIRST_NAME, LAST_NAME, EMAIL, USERNAME, HASHPASS, NEEDS_RESET) VALUES (7, 'Heather', 'Tiimlied', 'wolfemagnus@nevada.unr.edu', 'htiimlied', UPPER('6703e065ecddf99bb09fa9ed801690eceac578ed10a8309f17d230e2d822a874'), 'n'); --password_07
INSERT INTO EMPLOYEES (EMPLOYEE_ID, FIRST_NAME, LAST_NAME, EMAIL, USERNAME, HASHPASS, NEEDS_RESET) VALUES (8, 'Julian', 'Quartermaster', 'wolfemagnus@nevada.unr.edu', 'jquartermaster', UPPER('9ccebdbcbdbbdd089a1ffbd7c0965296337e4be53e6603a2931e29120b2fc0cd'), 'n'); --password_08
--MIDLEVEL MANAGER RELATIONSHIPS
INSERT INTO MANAGEMENT_HIERARCHY (MH_ID, SUBORDINATE, SUPERIOR) VALUES (1, 1, 6);
INSERT INTO MANAGEMENT_HIERARCHY (MH_ID, SUBORDINATE, SUPERIOR) VALUES (2, 2, 6);
INSERT INTO MANAGEMENT_HIERARCHY (MH_ID, SUBORDINATE, SUPERIOR) VALUES (3, 3, 6);
INSERT INTO MANAGEMENT_HIERARCHY (MH_ID, SUBORDINATE, SUPERIOR) VALUES (4, 4, 7);
INSERT INTO MANAGEMENT_HIERARCHY (MH_ID, SUBORDINATE, SUPERIOR) VALUES (5, 4, 8);
INSERT INTO MANAGEMENT_HIERARCHY (MH_ID, SUBORDINATE, SUPERIOR) VALUES (6, 5, 7);
INSERT INTO MANAGEMENT_HIERARCHY (MH_ID, SUBORDINATE, SUPERIOR) VALUES (7, 5, 8);
--TOP LEVEL MANAGER(S)
INSERT INTO EMPLOYEES (EMPLOYEE_ID, FIRST_NAME, LAST_NAME, EMAIL, USERNAME, HASHPASS, NEEDS_RESET) VALUES (9, 'Big', 'Boss', 'wolfemagnus@nevada.unr.edu', 'bigboss', UPPER('d10975373846bf5d38eed1b39acd55211d804d73469678a7f1d00e009a47117b'), 'n'); --top_snek
--TOP LEVEL MANAGEMENT RELATIONSHIPS
INSERT INTO MANAGEMENT_HIERARCHY (MH_ID, SUBORDINATE, SUPERIOR) VALUES (8, 6, 9);
INSERT INTO MANAGEMENT_HIERARCHY (MH_ID, SUBORDINATE, SUPERIOR) VALUES (9, 7, 9);
INSERT INTO MANAGEMENT_HIERARCHY (MH_ID, SUBORDINATE, SUPERIOR) VALUES (10, 8, 9);
--ADD FAUX REQUESTS (APPROVAL IS P PENDING, N NO, OR Y YES
INSERT INTO REQUESTS (REQ_ID, POST_EMPLOYEE, RESOLVING_MGR, APPROVAL_STATE, SUBJECT, EXPLANATION, AMOUNT) VALUES (1, 1, NULL, 'P', 'Server farm check-in', 'Had to check the server farms down in Tampa, flight and hotel cumulatively cost $800.01.', 800.01);
INSERT INTO REQUESTS (REQ_ID, POST_EMPLOYEE, RESOLVING_MGR, APPROVAL_STATE, SUBJECT, EXPLANATION, AMOUNT) VALUES (2, 1, 6, 'N', 'Wasting company money', 'This request is to be denied.', 1.00);
INSERT INTO REQUESTS (REQ_ID, POST_EMPLOYEE, RESOLVING_MGR, APPROVAL_STATE, SUBJECT, EXPLANATION, AMOUNT) VALUES (3, 1, 6, 'Y', 'Using company money well', 'This request is to be approved.', 6.00);
INSERT INTO REQUESTS (REQ_ID, POST_EMPLOYEE, RESOLVING_MGR, APPROVAL_STATE, SUBJECT, EXPLANATION, AMOUNT) VALUES (4, 4, 7, 'Y', 'Using company money well', 'This request is to be approved.', 2.00);
INSERT INTO REQUESTS (REQ_ID, POST_EMPLOYEE, RESOLVING_MGR, APPROVAL_STATE, SUBJECT, EXPLANATION, AMOUNT) VALUES (5, 4, 8, 'Y', 'Using company money well', 'This request is to be approved.', 12.00);
INSERT INTO REQUESTS (REQ_ID, POST_EMPLOYEE, RESOLVING_MGR, APPROVAL_STATE, SUBJECT, EXPLANATION, AMOUNT) VALUES (6, 7, 9, 'Y', 'Midlevel management level request', 'This request is to be approved.', 500.00);


--IN PROGRESS CLEANUP
/*
DROP TABLE REQUESTS;
DROP TABLE MANAGEMENT_HIERARCHY;
DROP TABLE EMPLOYEES;
DROP SEQUENCE EMPLOYEE_SEQ;
DROP SEQUENCE MGMT_HIER_SEQ;
DROP SEQUENCE REQUEST_SEQ;
DROP TRIGGER EMPLOYEE_ON_INSERT;
DROP TRIGGER MGMT_HIER_ON_INSERT;
DROP TRIGGER REQUEST_ON_INSERT;
*/